<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>buscar con sal</title>
    <script src="https://unpkg.com/lunr@2.3.9/lunr.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 15px;
            margin-top: 0;
        }
        .description {
            color: #1a1a1a;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.5;
        }
        .search-container {
            margin-bottom: 30px;
        }
        #search-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #000;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #search-input:focus {
            outline: none;
            border-color: #8B4513;
        }
        .results-count {
            margin-top: 10px;
            color: #666;
        }
        .article-list {
            display: grid;
            gap: 24px;
        }
        .article-item {
            border: 1px solid #000;
            border-radius: 12px;
            padding: 24px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            transition: all 0.2s ease;
        }
        .article-item:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .article-item h3 {
            margin-top: 0;
            margin-bottom: 12px;
            font-size: 1.25em;
            font-weight: 600;
            line-height: 1.3;
        }
        .article-item h3 a {
            color: #1a1a1a;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .article-item h3 a:hover {
            color: #8B4513;
            text-decoration: none;
        }
        .article-link {
            color: #8B4513;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95em;
            transition: color 0.2s ease;
        }
        .article-link:hover {
            color: #654321;
            text-decoration: underline;
        }
        .content-snippet {
            color: #666;
            font-size: 0.95em;
            margin: 12px 0;
            line-height: 1.6;
        }
        mark {
            background-color: #f4e4c1;
            padding: 2px 4px;
        }
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 40px;
            flex-direction: column;
            min-height: 200px;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #8B4513;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: #666;
            font-size: 16px;
        }
        .hidden {
            display: none;
        }
        .source-banner {
            background-color: #8B4513;
            color: #F5DEB3;
            padding: 16px 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 6px;
            font-family: Georgia, serif;
            font-style: italic;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid #654321;
        }
        .source-banner a {
            color: #FFF8DC;
            text-decoration: underline;
            font-weight: 600;
        }
        .source-banner a:hover {
            color: #FFFFFF;
        }
    </style>
</head>
<body>
    <div class="source-banner">
        All articles are from <a href="https://www.tortillaconsal.com/" target="_blank" rel="noopener"><em>tortilla con sal</em></a>
    </div>
    
    <div class="description">
        Search through articles from Tortilla con Sal by title or content. Full-text search across 8,000+ articles.
    </div>
    
    <div class="search-container">
        <input type="text" id="search-input" placeholder="buscar-con-sal: search articles by title or content...">
        <div class="results-count" id="results-count"></div>
    </div>
    
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
        <div class="loading-text">Loading articles...</div>
    </div>
    
    <div id="article-list" class="article-list hidden"></div>

    <script>
        let idx;
        let articles = [];
        let sortedArticles = []; // Cache sorted articles for performance
        let indexBuilt = false;
        
        // Show loading spinner immediately
        const loadingSpinner = document.getElementById('loading-spinner');
        const articleList = document.getElementById('article-list');
        loadingSpinner.style.display = 'flex';
        articleList.style.display = 'none';
        
        // Load the article index
        fetch('articles-index.json')
            .then(response => response.json())
            .then(data => {
                articles = data;
                
                // Build Lunr index (optimized - build once, reuse)
                const startTime = performance.now();
                idx = lunr(function() {
                    this.ref('id');
                    this.field('title', { boost: 10 });
                    this.field('content');
                    
                    articles.forEach((article, index) => {
                        this.add({
                            id: index,
                            title: article.title,
                            content: article.content
                        });
                    });
                });
                indexBuilt = true;
                const buildTime = performance.now() - startTime;
                console.log(`Index built in ${buildTime.toFixed(2)}ms`);
                
                // Hide loading spinner and show article list
                loadingSpinner.style.display = 'none';
                articleList.style.display = 'grid';
                
                // Sort articles by date (latest first) once and cache it
                sortedArticles = [...articles].sort((a, b) => {
                    const dateA = a.date || '0000-00-00'; // Put articles without dates at the end
                    const dateB = b.date || '0000-00-00';
                    return dateB.localeCompare(dateA); // Reverse order: latest first
                });
                displayArticles(sortedArticles.slice(0, 30), '', articles.length);
            })
            .catch(error => {
                console.error('Error loading articles:', error);
                loadingSpinner.style.display = 'none';
                articleList.style.display = 'block';
                articleList.innerHTML = 
                    '<p style="text-align: center; color: #e74c3c;">Error loading articles. Make sure articles-index.json exists. Run generate-index.py first.</p>';
            });
        
        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Optimized search function
        function performSearch(query) {
            if (!indexBuilt) {
                // Wait for index to be built
                setTimeout(() => performSearch(query), 100);
                return;
            }
            
            if (query.length === 0) {
                // Use cached sorted articles (sorted once on load)
                displayArticles(sortedArticles.slice(0, 30), '', articles.length);
                return;
            }
            
            const startTime = performance.now();
            let results = [];
            const queryLower = query.toLowerCase();
            
            // Optimized: Try wildcard first (fastest), then fallback to text search
            const wildcardQuery = query + '*';
            try {
                results = idx.search(wildcardQuery);
            } catch (e) {
                // Wildcard failed, will use text filter
            }
            
            // If no results from wildcard, use fast text filter
            if (results.length === 0) {
                // Pre-compute lowercase for performance
                const filtered = articles.filter(article => {
                    const titleLower = article.title.toLowerCase();
                    const contentLower = article.content.toLowerCase();
                    return titleLower.includes(queryLower) || contentLower.includes(queryLower);
                });
                results = filtered.map((article) => ({
                    ref: articles.indexOf(article).toString(),
                    score: 1.0
                }));
            }
            
            const resultIds = results.map(result => parseInt(result.ref));
            const filteredArticles = resultIds.map(id => articles[id]).filter(a => a !== undefined);
            
            const searchTime = performance.now() - startTime;
            console.log(`Search completed in ${searchTime.toFixed(2)}ms`);
            
            displayArticles(filteredArticles, query, filteredArticles.length);
        }
        
        // Search functionality with debouncing (400ms delay for better performance with large datasets)
        const debouncedSearch = debounce(performSearch, 400);
        document.getElementById('search-input').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            debouncedSearch(query);
        });
        
        function displayArticles(articlesToShow, searchQuery = '', totalCount = null) {
            const container = document.getElementById('article-list');
            const countEl = document.getElementById('results-count');
            
            if (articlesToShow.length === 0) {
                container.innerHTML = '<p>No articles found.</p>';
                countEl.textContent = '0 results';
                return;
            }
            
            // Show accurate count - if totalCount provided, show "X of Y", otherwise just count
            if (totalCount !== null && totalCount >= articlesToShow.length) {
                if (totalCount > articlesToShow.length) {
                    countEl.textContent = `Showing ${articlesToShow.length} of ${totalCount} article${totalCount !== 1 ? 's' : ''}`;
                } else {
                    countEl.textContent = `${totalCount} article${totalCount !== 1 ? 's' : ''} found`;
                }
            } else {
                countEl.textContent = `${articlesToShow.length} article${articlesToShow.length !== 1 ? 's' : ''} found`;
            }
            
            // Limit display to first 50 results for performance (reduced from 100 for 8000+ articles)
            const displayLimit = 50;
            const articlesToDisplay = articlesToShow.slice(0, displayLimit);
            const hasMore = articlesToShow.length > displayLimit;
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            const tempDiv = document.createElement('div');
            
            tempDiv.innerHTML = articlesToDisplay.map(article => {
                // Format date for display
                let dateDisplay = '';
                if (article.date) {
                    try {
                        const dateObj = new Date(article.date + 'T00:00:00');
                        dateDisplay = dateObj.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                    } catch (e) {
                        dateDisplay = article.date; // Fallback to raw date
                    }
                }
                
                // Only show content snippet if searching (optimize)
                let contentSnippet = '';
                if (searchQuery && article.content && searchQuery.length >= 3) {
                    const queryLower = searchQuery.toLowerCase();
                    const contentLower = article.content.toLowerCase();
                    const matchIndex = contentLower.indexOf(queryLower);
                    
                    if (matchIndex !== -1) {
                        // Get snippet around the match (60 chars before and after for performance)
                        const start = Math.max(0, matchIndex - 60);
                        const end = Math.min(article.content.length, matchIndex + searchQuery.length + 60);
                        let snippet = article.content.substring(start, end);
                        if (start > 0) snippet = '...' + snippet;
                        if (end < article.content.length) snippet = snippet + '...';
                        contentSnippet = `<p class="content-snippet">${highlightText(snippet, searchQuery)}</p>`;
                    }
                }
                
                return `
                <div class="article-item">
                    <h3><a href="${article.path}">${highlightText(article.title, searchQuery)}</a></h3>
                    ${dateDisplay ? `<div class="article-date">${dateDisplay}</div>` : ''}
                    ${contentSnippet}
                    <p><a href="${article.path}" class="article-link">Read article â†’</a></p>
                </div>
            `;
            }).join('');
            
            if (hasMore) {
                tempDiv.innerHTML += `<p style="text-align: center; color: #666; margin-top: 20px;">Showing first ${displayLimit} of ${articlesToShow.length} results. Refine your search to see more.</p>`;
            }
            
            container.innerHTML = tempDiv.innerHTML;
        }
        
        function highlightText(text, query) {
            if (!query) return escapeHtml(text);
            const escapedText = escapeHtml(text);
            const escapedQuery = escapeHtml(query);
            const regex = new RegExp(`(${escapedQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escapedText.replace(regex, '<mark>$1</mark>');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

